---
layout: post
title: "Lesson 03: Raster Calculations - Overlay & Raster Math in R"
date:   2015-10-26
authors: [Jason Williams, Jeff Hollister, Kristina Riemer, Mike Smorul, Zack Brym, Leah Wasser]
contributors: [Megan A. Jones]
packagesLibraries: [raster, rgdal]
dateCreated:  2015-10-23
lastModified: `r format(Sys.time(), "%Y-%m-%d")`
category: spatio-temporal-workshop
tags: [module-1]
mainTag: GIS-Spatial-Data
description: "This lesson covers how to use the overlay function in R to perform
efficient raster calculations. It also explains the basic principles of writing
functions in R."
code1: 
image:
  feature: NEONCarpentryHeader_2.png
  credit: A collaboration between the National Ecological Observatory Network (NEON) and Data Carpentry
  creditlink: http://www.neoninc.org
permalink: /R/Modify-Rasters-In-R
comments: false
---

{% include _toc.html %}

##About
When dealing with spatial data, we often want to perform calculaions on rasters 
or combine multiple rasters to create a new output raster.This lesson will cover 
some of the most common functions to modify rasters including `overlay`, `calc` and raster math.

**R Skill Level:** Intermediate - you've got the basics of `R` down.

<div id="objectives" markdown="1">

###Goals / Objectives

After completing this activity, you will:

* Be able to to perform a subtraction (difference) between two rasters using 
raster math.
* Know how to perform a more efficient subtraction (difference) between two 
rasters using the raster `overlay()` function in R.

###Things You'll Need To Complete This Lesson

Please be sure you have the most current version of `R` and, preferably,
R studio to write your code.

####R Libraries to Install:

* **raster:** `install.packages("raster")`
* **rgdal:** `install.packages("rgdal")`

####Data to Download

Download the workshop data:

* <a href="http://files.figshare.com/2387965/NEON_RemoteSensing.zip" class="btn btn-success"> DOWNLOAD Sample NEON Raster Data Derived from LiDAR over Harvard
Forest and SJER Field Sites</a>

The LiDAR and imagery data used to create the rasters in this dataset were 
collected over the Harvard and San Joaquin field sites 
and processed at <a href="http://www.neoninc.org" target="_blank" >NEON </a> 
headquarters. The entire dataset can be accessed by request from the NEON website. 

####Recommended Pre-Lesson Reading

* <a href="http://cran.r-project.org/web/packages/raster/raster.pdf" target="_blank">
Read more about the `raster` package in R.</a>

</div>

#Manipulating Rasters in R
As introduced in Lesson 02, we often want to overlay two or more rasters on top 
of each other, and perform calculations to create a new output raster. If 
interested in measuring the heights of trees, then what we really want is the 
`difference` between the Digital Surface Model (`DSM`, tops of trees) and the 
Digital Terrain Model (`DTM`, ground level) .This data product is often referred
to as a Canopy Height Model (`CHM`) and represents the actual height of trees, 
buildings, etc above the ground.

We can calculate this difference in two different ways:
1) by subtracting the two rasters in `R` 
or if our rasters are large
2) using the `overlay()` function to more efficiently calculate the difference.

First, we'll learn the intuitive first step of subtracting layers to create and
plot a `CHM`.  In the geospatial world we often call
this *raster math*.

If you completed Lessons 00 and 02 you've already loaded and viewed 
`HARV_dtmCrop.tif` and `HARV_dsmCrop.tif` and can skip this code chunk.  If you 
have not completed it, let's load and check out our raster files. 
```{r load-libraries }
#load raster package
library(raster)

#view info about the dtm & dsm raster data
GDALinfo("NEON_RemoteSensing/HARV/DTM/HARV_dtmCrop.tif")
GDALinfo("NEON_RemoteSensing/HARV/DTM/HARV_dsmCrop.tif")
#load the DTM & DSM rasters
DTM <- raster("NEON_RemoteSensing/HARV/DTM/HARV_dtmCrop.tif")
DSM <- raster("NEON_RemoteSensing/HARV/DSM/HARV_dsmCrop.tif")
#create a quick plot of each to see what we're dealing with
plot(DTM,
     main="Digital Terrain Model (Elevation)\n Harvard Forest")

plot(DSM,
     main="Digital Surface Model (Elevation)\n Harvard Forest")
```

Once the data are loaded, we can use mathametical operations on them.
For instance, we can subtract the DTM from the DSM to create a Canopy Height
Model.

```{r raster-math }
# Raster math example
CHM <- DSM - DTM 

#view the output CHM
plot(CHM,
     main="NEON Canopy Height Model - Subtracted\n Harvard Forest") 
```
Notice the legend on the right.  We are now looking at the height of the canopy 
instead of the elevation hence the smaller numbers.  

#Challenge: Exploring Raster Values in CHM
As we learned in previous lessons, it's often a good idea to explore the range 
of values in a raster dataset just like we might explore a dataset that we 
collected in the field.  

1. What range of values do you expect to see for the Harvard Forest Canopy 
Height Model (`CHM`) that we just created? 
2. What are two ways you can check this range of data in CHM? 
3. Plot your data in such a way that you can see the range of data values in 
CHM.
4. Bonus challenge: Change the color of and add a title to the plot you created 
in question 3. 

```{r challenge-code-1 }
#1) Depends on types of trees.  0m to <50m?
#2) Looks at histogram or min/max values. 
minValue(CHM)
maxValue(CHM)
#3) 
hist(CHM, maxpixels=ncell(CHM))

#4)
hist(CHM, 
     col = "purple",
     main = "Histogram of NEON Canopy Height Model\n Harvard Forest",
     maxpixels=ncell(CHM))

```

#Efficient Raster Math: Overlay Function
Basic raster math like we just did, is an appropriate aporoach to a calculation 
if

1. The rasters we are using are small in size.
2. The calculations we are performing are simple.

Raster math is intuitive and easy to code, however it is less efficient as 
computation becomes more complex or as file sizes become larger. The `overlay()`
function is more efficient when

1. The rasters we are using are larger in size. 
2. The rasters are stored as individual files. 
3. The computations needed are complex. 

>NOTE: If the rasters are stacked and stored as `RasterStack` or `RasterBrick`
>objects in R, then we should use `calc()`. `overlay()` will not work on stacked
>rasters. 

The `overlay()` function takes two or more rasters and applies a function to
them using efficient processing methods. The syntax is

`outputRaster <- overlay(raster1, raster2, fun=functionName)`

##Writing Functions in R
Before we can continue with `overlay()` we need to discuss writing functions. A 
function represents a set of tasks that need to be repeated over and over. 

LINK TO MORE ABOUT FUNCTIONS IN R 
I like explanations (how to AND why) here: http://nicercode.github.io/guides/functions/
but I'm hesitant to link to blogs that might disappear so also QuickR link:
http://www.statmethods.net/management/userfunctions.html
Thoughts? 

A simplified syntax for a function in R is as follows:

`functionName <- function(variable1, variable2){WhatYouWantDone, WhatToReturn}`

Let's say we want to create a function that subtracts one raster from another. 
In our case what we want does is what we want returned so we don't have to 
specify it twice. 
```{r create-function }
#this function will take two rasters (r1 and r2) and subtract them
subtRasters <- function(r1, r2){
(r1-r2)
}
```

We now have a function called `subtRasters` that will subtract any two rasters
that we give it.  

##Continuing with Overlay Function
Let's repeat our simple raster math computation using `overlay()` and the
function we just created. 
```{r raster-overlay }
CHM_ov<- overlay(DSM,DTM,fun=subtRasters)

plot(CHM_ov,
     main="NEON Canopy Height Model - Overlay Subtract\n Harvard Forest")
```

#Writing Raster Files
So now we've learned two different ways to do calculations (in our case 
subtraction) with two rasters in R.  This gives us an output raster object 
(`CHM_ov`), we can use the `writeRaster` function to export the object as a new 
geotiff. 

>NAMES: Part of writing a raster (or any file) is choosing a suitable name for 
>the file.  File names should be make it clear what is in the file.  This is 
>also true with object names in R.  In fact, so far in these lessons we've been 
>using poor nameing practices as we haven't been including any information about
>the location in our names (eg. `DSM` not `DSM_HARV`).  This hasn't gotten us 
>in trouble as we've only been working in one location (Harvard Forest), 
>however, it is still good practice to be specific with file and object names.

When we write this raster object to a GeoTIFF file we'll name it 
`chm_ov_HARV.tiff` this way we know that it is a canopy height model of Harvard 
Forest created using overlay.  Any files you write will be saved in whichever 
file is the current working directory. 

```{r write-raster }
#export CHM object to new GeotIFF
writeRaster(CHM_ov,"chm_ov_HARV.tiff",
            format="GTiff", 
            overwrite=TRUE, 
            NAflag=-9999)
```

In the code we specify that the format will be GTiff. Overwrite is true so that
it replaces any other file with this name.  This is a useful setting so that you
can make a change to the object and then update the file by re-runing the code.
However, be careful to never accidentally re-use a name for a file that already 
exists. We are setting the NA value to -9999 for consistency. 
####CONSISTENCY WITH WHAT?  NOT PREVIOUSLY MENTIONED


#Challenge: Exploring the San Joaquin field site.  
As ecologists we may want to explore the phenology of two different sites.  The 
San Joaquin valley in California is rather different from the Harvard Forest in 
Massachusetts and could make a good comparison.  

LiDAR and imagery data used to create the rasters were collected at the San 
Joaquin NEON field sites the same as for the Harvard Forest NEON field sites. 

Your challenge is to import the San Joaquin raster files so that we can compare 
to two sites. So that we can use object/file names in future lessons names 
should follow the format of objectType_SJER (e.g. `DSM_SJER`).

1. Import the DSM and DTM from the SJER directory. Don't forget to examine the
data for CRS, bad values, etc. 
2. Create a CHM from the two raster layers and check to make sure the data are 
what you expect. 
3. Plot the CHM from SJER. 
4. Export as a GeoTIFF.
5. What do you notice about tree heights at the two sites?

```{r SJER-CHM, }
#1.
#load the DTM
DTM_SJER <- raster("NEON_RemoteSensing/SJER/DTM/SJER_dtmCrop.tif")
#load the DSM
DSM_SJER <- raster("NEON_RemoteSensing/SJER/DSM/SJER_dsmCrop.tif")

#check CRS, units, etc
DTM_SJER@data
DSM_SJER@data

#check values
hist(DTM_SJER, maxpixels=ncell(DTM_SJER))
hist(DSM_SJER, maxpixels=ncell(DSM_SJER))

#2.
#use overlay to subtract the two rasters
CHM_ov_SJER <- overlay(DSM_SJER,DTM_SJER,fun=subtRasters)

hist(CHM_ov_SJER, 
     main="NEON Canopy Height Model - Histogram\n SJER")

#3
#plot the output
plot(CHM_ov_SJER,
     main="NEON Canopy Height Model - Overlay Subtract\n SJER")

#4 
#Write to object to file
writeRaster(CHM_ov_SJER,"chm_ov_SJER.tiff",
            format="GTiff", 
            overwrite=TRUE, 
            NAflag=-9999)

#4.  Tree heights are WAY shorter in SJER. 
#view histogram of HARV again. 
hist(CHM_ov, 
     main="NEON Canopy Height Model - Histogram\n HARV")
```
