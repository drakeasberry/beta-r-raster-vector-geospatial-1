---
layout: post
title: "Lesson 00: Intro to Raster Data in R"
date:   2015-10-29
authors: [Kristina Riemer, Zack Brym, Jason Williams, Jeff Hollister,  Mike Smorul, Leah Wasser]
contributors: [Megan A. Jones]
dateCreated:  2015-10-23
lastModified: `r format(Sys.time(), "%Y-%m-%d")`
packagesLibraries: [raster, rgdal]
category:  
tags: [module-1]
mainTag: GIS-Spatial-Data
description: "This lesson review the fundamental principles, libraries and 
metadata / raster attributes that you need to be familiar with in order to 
successfully work with raster data in R."
code1: 
image:
  feature: NEONCarpentryHeader_2.png
  credit: A collaboration between the National Ecological Observatory Network (NEON) and Data Carpentry
  creditlink: http://www.neoninc.org
permalink: /R/Introduction-to-Raster-Data-In-R
comments: false
---

{% include _toc.html %}

##About
In this lesson, we will cover the basics of raster data and how to how to open, 
plotand explore raster data properties in `R`.

**R Skill Level:** Intermediate - you've got the basics of `R` down.

<div id="objectives" markdown="1">

###Goals / Objectives

After completing this activity, you will:

* Understand what a raster dataset is and its fundamental attributes.
* Know how to explore raster attributes in `R`.
* Be able to import rasters into `R` using the `raster` library.
* Be able to quickly plot a raster file in `R`.
* Understand the difference between single- and mult-band rasters.

###Things You'll Need To Complete This Lesson
You will need the most current version of R, and preferably RStudio, loaded on
your computer to complete this lesson.

####R Libraries to Install:

* **raster:** `install.packages("raster")`
* **rgdal:** `install.packages("rgdal")`


####Data to Download

Download the raster files for the Harvard Forest dataset:

<a href="http://files.figshare.com/2434040/NEON_RemoteSensing.zip" class="btn btn-success"> DOWNLOAD Sample NEON Airborne Observation Platform Raster Data</a> 

The LiDAR and imagery data used to create the rasters in this dataset were 
collected over the <a href="http://www.neoninc.org/science-design/field-sites/harvard-forest" target="_blank" >Harvard</a> and 
<a href="http://www.neoninc.org/science-design/field-sites/san-joaquin-experimental-range" target="_blank" >San Joaquin</a> field sites 
and processed at <a href="http://www.neoninc.org" target="_blank" >NEON </a> 
headquarters. The entire dataset can be accessed by request from the 
<a href="http://www.neoninc.org/data-resources/get-data/airborne-data" target="_blank"> NEON 
website.</a>

####Recommended Pre-Lesson Reading

* <a href="http://cran.r-project.org/web/packages/raster/raster.pdf" target="_blank">
Read more about the `raster` package in R.</a>
* <a href="http://neondataskills.org/R/Raster-Data-In-R/" target="_blank" > 
Intro to Raster Data - NEON Data Skills</a>


####Raster Lesson Series 
This lesson is a part of a series of raster data in R lessons:

* [Lesson 00 - Intro to Raster Data in R]({{ site.baseurl}}/R/Introduction-to-Raster-Data-In-R/)
* [Lesson 01 - Plot Raster Data in R]({{ site.baseurl}}/R/Plot-Rasters-In-R/)
* [Lesson 02 - Reproject Raster Data in R]({{ site.baseurl}}/R/Reproject-Raster-In-R/)
* [Lesson 03 - Raster Calculations in R]({{ site.baseurl}}/R/Raster-Calculations-In-R/)
* [Lesson 04 - Work With Multi-Band Rasters - Images in R]({{ site.baseurl}}/R/Multi-Band-Rasters-In-R/)
* [Lesson 05 - Raster Time Series Data in R]({{ site.baseurl}}/R/Raster-Times-Series-Data-In-R/)
* [Lesson 06 - Plot Raster Time Series Data in R Using RasterVis and LevelPlot]({{ site.baseurl}}/R/Plot-Raster-Times-Series-Data-In-R/)


</div>

#About Raster Data
Raster or "gridded" data are saved on a regular grid which is rendered on a map
as pixels. Each pixel contains a value that represents an area on the Earth's 
surface.


![What Is A Raster Dataset]({{ site.baseurl }}/images/raster_concept.png)

#Types of data stored as rasters
Raster data can be continuous or categorical. Continuous rasters can have a 
range of quantitative values. Some examples of continuous rasters include:

1. Precipitation maps.
2. Maps of tree height derived from LiDAR data.
3. Elevation values for a region. 

A map of elevation for Harvard Forest derived from the NEON AOP LiDAR sensor
is below. Notice that elevation is a continuous numeric variable. The legend
represents the continuous range of values in the data from ~300 to 400+ meters.

```{r load-libraries-1, results='hide', echo=FALSE}

library(raster)
library(rgdal)

```


```{r elevation-map, echo=FALSE}
#render DSM for lesson content background
DSM_HARV <- raster("NEON_RemoteSensing/HARV/DSM/HARV_dsmCrop.tif")

# code output here - DEM rendered on the screen
plot(DSM_HARV, main="NEON Elevation Map\nHarvard Forest")

```

Some rasters contain categorical data. Thus each pixel represents a class such
as a landcover class ("forest") rather than a continuous value such as elevation 
or temperature. Some examples of classified maps include:

1. Landcover / landuse maps.
2. Tree height maps classified short, medium, tall trees.
3. Elevation maps classified low, medium and high elevation.

The legend of this map shows the colors representing each discrete class. 

```{r classified-elevation-map, echo=FALSE}
# Just a demonstration image for the lesson

#add a color map with 5 colors
col=terrain.colors(3)
#add breaks to the colormap (6 breaks = 5 segments)
brk <- c(250,350, 380,500)

# Expand right side of clipping rect to make room for the legend
par(xpd = FALSE,mar=c(5.1, 4.1, 4.1, 4.5))
#DEM with a custom legend
plot(DSM_HARV, col=col, breaks=brk, main="Classified Elevation Map\nHarvard Forest",legend = FALSE)
#turn xpd back on to force the legend to fit next to the plot.
par(xpd = TRUE)
#add a legend - but make it appear outside of the plot
legend( par()$usr[2], 4713700,
        legend = c("High Elevation", "Middle","Low Elevation"), 
        fill = rev(col))
```

###Categorical Landcover Map for the United States 
![US NLCD Map](http://neondataskills.org/images/spatialData/NLCD06_conus_lg.gif)

#What is a GeoTIFF??
Raster data can come in many different formats. In this lesson, we will use the 
`geotiff` format which has the extension `.tif`. A `.tif` file store metadata
or attributes about the file as embedded `tif tags`. For instance, your camera might 
store a tag that describes the make and model of the camera or the date the
photo was taken when it saves a `tif`. A GeoTIFF is a standard `.tif` image
format with addition spatial (georeferencing) information embedded in the file
as a tag. These tags can include the following raster metadata:

1. A `Coordinate Reference System (CRS)`
2. Spatial Extent
3. `NoData` Values 
4. The `resolution` of the data

In this lesson we will discuss all of these metadata tags.

> More about the  `.tif` format:
> 
> * <a href="https://en.wikipedia.org/wiki/GeoTIFF" target="_blank"> Geotiff on Wikipedia</a>
> * <a href="https://trac.osgeo.org/geotiff/" target="_blank"> OSGEO Tiff documentation</a>

##Raster Data in R

We will begin by opening up a raster dataset in `R` and exploring its metadata.
To open rasters in `R`, we will use the `raster` and `rgdal` libraries.

NOTE ON WORKING DIRECTORY: Your working directory needs to be set to the 
location where the data you downloaded for this lesson is.  If you do not know 
how to do this please refer to this how-to for working directories. LINK. 
{: .notice}

```{r load-libraries }
#load libraries
library(raster)
library(rgdal)

```

##Open a raster in R
We can use the `raster("path-to-raster-here")` function to open a raster in R. 



> NAMES: To improve code readability, file and object names should be make it 
> clear what is in the file. The data for this lesson were collected over 
> from Harvard Forest so we'll use a naming convention of data_HARV.

```{r open-raster }
# Make sure to set the directory to your data
# setwd("path-to-data-here")

# Load raster into R
DSM_HARV <- raster("NEON_RemoteSensing/HARV/DSM/HARV_dsmCrop.tif")

# View raster structure
DSM_HARV 

#quickly plot the raster
#note \n in the title forces a line break in the title
plot(DSM_HARV, 
     main="NEON Digital Surface Model\nHarvard Forest")

```

Here is a map showing the elevation of our site in Harvard Forest.  Does this 
are top out at just over 400 meters or 400 feet?  Perhaps we need to learn more 
about attributes and metadata!

## Coordinate Reference System
The Coordinate Reference System or `CRS` tells R where the raster is located in 
geographic space. It also tells `R` what method should be used to "flatten" or 
project the raster in geographic space. 

#PROJECTION DISCUSSION - **brief** intro to each with links out. 

* ** Geographic Coordinate System **
* ** Why projections are needed **
* ** Common projections **

![UTM Coordinate system](http://upload.wikimedia.org/wikipedia/en/thumb/5/57/Utm-zones.svg/720px-Utm-zones.svg.png)

* Datums
* Additional Links:
 <a href="https://www.nceas.ucsb.edu/~frazier/RSpatialGuides/OverviewCoordinateReferenceSystems.pdf" target="_blank"> NCEAS Overview of CRS in R</a>


We can view just the CRS string associated with our `R` object using the`crs()` 
method. We can assign this string to an `R` object too.

```{r view-resolution-units}
#view resolution units
crs(DSM_HARV)

#assign crs to an object (class) to use for reprojection and other tasks
myCRS <- crs(DSM_HARV)
myCRS
```

The CRS in this case is in a `PROJ 4` format. This means that the projection
information is strung together as a series of text elements, each of which 
begins with a `+` sign. 

 `+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0`

We'll focus on the first few components of the CRS in this lesson.

* `+proj=utm` The projection of the dataset. Our data are in Universal 
Transverse Mercator (UTM).  
* `+zone=18` The UTM projection divides up the world into zones, this element
tells you which zone the data is in. Harvard Forest is in Zone 18.
* `+datum=WGS84` The datum was used to define the center point of the 
projection. Our raster uses the `WGS84` datum.
* `+units=m` This is the horizontal units that the data are in. Our units 
are meters. 

## Resolution
A raster has horizontal (x and y) resolution. This resolution represents the 
area on the ground that each pixel covers. We will need to know the units used 
to calculate the resolution. In our data the units are meters. This means that 
if the data are 1x1 resolution, that each pixel represents a 1 x 1 meter area
on the ground.

![raster resolution]({{ site.baseurl}}/images/raster_resolution.png)

NOTE: We can view resolution units using two methods: viewing the 
coordinate reference system string `crs()` OR using `@data`. 
If you enter `DSM_HARV@data`, you'll see that units were not embedded in the `tif 
tags` for this raster.
{ : .notice }

#Calculate the Min and Max values for the raster

When exploring a raster data, we often want to know the min or max values. In this
case, we are working with elevation data, it might be useful to know the min/max
elevation range at our site.

Raster statistics are often calculated and embedded in a `geotiff` for us. However
if they weren't already calculated, we can calculate them using the `setMinMax()` 
function.

```{r set-min-max }

#This is the code if min/max weren't calculated: 
#DSM_HARV <- setMinMax(DSM_HARV) 

#view the calculated min value
minValue(DSM_HARV)

#view only max value
maxValue(DSM_HARV)

```

We can see that the elevation at our site ranges from 305.07m to 416.07m. Thus, 
there is not a huge amount of variability in this particular dataset.

##NoData Values in Rasters

Raster data often has a `noData` value associated with it. This is a value assigned
to pixels where no data were collected or are available. 

By default the shape of a raster is always square or rectangular. Thus, if we have 
a dataset that has a shape that isn't square or rectangular, some pixels at the 
edge of the raster will have no data. This often happens when the data were 
collected by an airplane which only flew over some of a particular region. 

In the image below, the pixels that are black, have no data associated with them.
The camera did not collect data in these areas. 

```{r demonstrate-no-data-blaco, echo=FALSE }
#demonstration code below - not being taught - just demonstrating no data values
# Use stack function to read in all bands
RGB_stack <- stack("NEON_RemoteSensing/HARV/HARV_RGB_Ortho.tif")

# Create an RGB image from the raster stack
par(col.axis="white",col.lab="white",tck=0)
plotRGB(RGB_stack, r = 1, g = 2, b = 3, 
        axes=TRUE, main="Raster With No Data Values\nRendered in Black")

```

Below - the black edges have been assigned NoDataValues (`NA`). R doesn't render 
pixels that contain no values. Instead they are assigned `NA`.

```{r demonstrate-no-data, echo=FALSE}
#reassign cells with 0,0,0 to NA
#this is simply demonstration code - we will not teach this.
f <- function(x) {
  x[rowSums(x == 0) == 3, ] <- NA
  x}

newRGBImage <- calc(RGB_stack, f)


par(col.axis="white",col.lab="white",tck=0)
# Create an RGB image from the raster stack
plotRGB(newRGBImage, r = 1, g = 2, b = 3,
        axes=TRUE, main="Raster With No Data Values\nNodata= NA")
 
```

##No Data Value Standard 

The assigned `noData` value may vary across disciplines. `-9999` is a common value 
used in both the remote sensing world and the eddy covariance world. It is also
the standard used by the National Ecological Observatory Network (NEON). 

If we are lucky, our geoTIFF file has a tag that tells us what the NoData value is. 
If we are less lucky, we can find that information in the raster's metadata.
If a NoDataValue was stored in the GeoTIFF tag, when R opens up the raster,
it will assign each instance of that value to `NA` (no data in R world). Values
of `NA` will be ignored by R.

## Bad Data Values in Rasters

Bad data values are different from NoData values. Sometimes a raster's metadata 
will tell us a value range of values for the raster. Sometimes, we need to use 
some practial scientific insight as we examine the data - just as we would for 
field data to identify questionable values. 

### Create A Histogram of Raster Values

We can explore the full range of values contained within our raster using the 
`hist` function which produces a histogram. This can often help us identify outlier
or bad data values in our raster.

```{r view-raster-histogram }

#view histogram of data
hist(DSM_HARV,
     main="Digital Surface Model - Range of Values\n NEON Harvard Forest")

```

NOTE: notice that an error message is thrown when R creates the histogram. `## 
Warning in .hist1(x, maxpixels = maxpixels, main = main, plot = plot, ...):
## 4% of the raster cells were used. 100000 values used.`. This error is caused
by the default maximum pixels value of 100,000 associated with the `hist` function.
This maximum value is to ensure efficiency as our data become larger!
We can define the max pixels to ensure that all pixel values are included in the
histogram. **USE THIS WITH CAUTION!**
{ : .notice }


``` {r view-raster-histogram2}
#NOTE: force R to plot all pixel values in the histogram COULD be problematic
#when dealing with very large datasets. USE WITH CAUTION!

#View the total number of pixels (cells) in is our raster 
ncell(DSM_HARV)

#create histogram that includes with all pixel values in the raster
hist(DSM_HARV, 
     maxpixels=ncell(DSM_HARV),
     main="Digital Surface Model Histogram\n All Pixel values Included")

```

Note that the shape of both histograms looks similar. R simple creates a histogram
with a smaller representative subset of our data. The distribution of elevation
values for our `Digital Surface Model (DSM)` looks reasonable. It is likely there
are no bad data values in this particular raster.

##Raster Bands

The Digital Surface Model object ( `DSM_HARV`) that we've been working with 
is a single band raster. This means that there is only one dataset - stored in 
the raster - surface elevation in meters, for one time period over Harvard Forest.

We can view the number of bands in a raster using the `nlayers()` method. 

```{r view-raster-bands }

#view unmber of bands
nlayers(DSM_HARV)

```


However, raster data can also be multi-band meaning that within one file it
contains data on multiple variables for each cell. By default the `raster` 
function only imports the first band in a raster regardless of whether it has 1
or more bands. We will cover multi-band rasters in Lesson 04:  

<a href="{{ site.baseurl }}/NEON-R-Spatial-Raster/R/Multi-Band-Rasters-In-R/" target="_blank"> Work with Multi-band Rasters: Images in R</a>.

#COLIN ![Image on what bands are...]()

##View Raster File Attributes

Remember that a `GeoTIFF` contains a set of embedded tags that contain 
metadata about the raster. So far, we've explored raster metadata AFTER importing 
it in `R`. However, we can use the `GDALinfo("path-to-raster-here")` function to view raster
metadata before we open the data in `R`.


```{r view-attributes-gdal}

# view attributes before opening file
GDALinfo("NEON_RemoteSensing/HARV/DSM/HARV_dsmCrop.tif")

```

Notice a few things in the output:

1. A projection is described as a string - this format is called `proj4`
   `+proj=utm +zone=18 +datum=WGS84 +units=m +no_defs `
2. We can se a `NoDataValue` (-9999)
3. We can tell how many `bands` the file contains (1)
4. We can view the x and y `resolution` of the data (1)
5. We can see the min and max values of the data `Bmin` and `Bmax`

It is ideal to use `GDALinfo` to explore your file BEFORE reading it into `R`.

#Challenge: Explore Raster Metadata 

In Lesson 01 we will use the file `NEON_RemoteSensing/HARV/DSM/HARV_DSMhill.tif`.

Without using the `raster` function to read the file into `R`, determine the
following about the file:

1. Does this file has the same `CRS` as `DSM_HARV`?
2. What is the `NoData` value?
3. What is resolution of the raster data? 
4. How large would a 5x5 pixel area would be on the Earth's surface? 
5. Is the file is a multi- or single-band raster?

>NOTE: this file is a `hillshade`. We will learn about hillshades in the next, 
>lesson!

``` {r challenge-code-attributes, echo=FALSE, results='hide'}
GDALinfo("NEON_RemoteSensing/HARV/DSM/HARV_DSMhill.tif")

#ANSWERS ###
# 1. If this file has the same CRS as DSM_HARV?  Yes: UTM Zone 18, WGS84, meters. 
#2. What format NoData values take?  -9999
#3. The resolution of the raster data? 1x1
#4. How large a 5x5 pixel area would be? 5mx5m How? We are given resolution of 
#1x1 and units in meters, therefore rolution of 5x5 means 5x5m. 
#5. If the file is a multi- or single-band raster?  Single 

```

