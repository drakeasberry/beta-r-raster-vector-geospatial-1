---
title: "Create Publication-quality Graphics"
teaching: 20
exercises: 10
questions:
- "How can I distinguish between the different times plotted using color?"
objectives:
- "Be able to assign custom names to bands in a RasterStack for prettier plotting."
- "Understand advanced plotting of rasters using the `ggplot2` package."
keypoints:
- ""
---

```{r setup, echo=FALSE}
source("../bin/chunk-options.R")
source("../setup.R")
knitr_fig_path("13-")
```

```{r load-libraries, echo = FALSE, results='hide', message = FALSE}
library(raster)
library(rgdal)
library(ggplot2)
library(dplyr)
library(reshape)
library(RColorBrewer)
library(scales)
```

```{r load-data, echo = FALSE, results = 'hide'}
# load in data
# learners will have this data loaded from the previous episode

all_NDVI_HARV <- list.files("data/NEON-DS-Landsat-NDVI/HARV/2011/NDVI", full.names = TRUE, pattern = ".tif$")

# Create a time series raster stack
NDVI_HARV_stack <- stack(all_NDVI_HARV)

# apply scale factor
NDVI_HARV_stack <- NDVI_HARV_stack/10000

# convert to a df for plotting 
NDVI_HARV_stack_df <- raster::as.data.frame(NDVI_HARV_stack, xy = TRUE) %>%
# Then reshape data to stack all the X*_HARV_ndvi_crop columns into
# one single column called 'variable'
    melt(id.vars = c('x','y'))
```


> ## Things Youâ€™ll Need To Complete This Episode
> See the [lesson homepage]({{ site.baseurl }}) for detailed information about the software,
> data, and other prerequisites you will need to work through the examples in this episode.
{: .prereq}

This episode covers how to customize your raster plors using the `ggplot2` package
in `R` to create publication-quality plots. 

## Before and After

In [the previous episode]({{ site.baseurl }}/12-time-series-raster/), we learned how to plot multi-band
raster data in `R` using the `facet_wrap()` function. This created a separate panel in our plot
for each raster band. The plot we created together is shown below: 

```{r levelplot-time-series-before, echo = FALSE}
ggplot() +
  geom_raster(data = NDVI_HARV_stack_df , aes(x = x, y = y, fill = value)) +
  facet_wrap(~variable) +
  ggtitle("Landsat NDVI\nNEON Harvard Forest")
```

Although this plot is informative, it isn't something we would expect to see in a journal publication. The x
and y-axis labels aren't informative. There is a lot of unnecessary gray background and the titles of
each panel don't clearly state that the number refers to the Julian day the data was collected. In this
episode, we will customize this plot above to produce a publication quality graphic. We will go through these steps iteratively. When we're done, we will have created the plot shown below.

```{r levelplot-time-series-after, echo = FALSE}
ggplot() +
  geom_raster(data = NDVI_HARV_stack_df , aes(x = x, y = y, fill = value)) +
  facet_wrap(~variable, nrow = 3, ncol = 5, labeller = labeller(variable = labels_names)) +
  ggtitle("Landsat NDVI - Julian Days", subtitle = "Harvard Forest 2011") +
  theme_void() +
  theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) + 
  coord_equal() +
  scale_fill_gradientn(name = "NDVI", colours = cols(20))
```


```{r levelplot-time-series, echo = FALSE }
ggplot() +
# Add main title
  geom_raster(data = NDVI_HARV_stack_df , aes(x = x, y = y, fill = value)) +
# we use ggplot2 faceting technique to split the plot into multiple plots
# based on the factor called 'variable'
  facet_wrap(~variable) +
  ggtitle("Landsat NDVI\nNEON Harvard Forest") +
# justify horizontally the title by giving a value of 0.5 (hjust is between [0,1])
  theme(plot.title = element_text(hjust = 0.5))
```

## Adjust the Color Ramp
Next, let's adjust the color ramp used to render the rasters. First, we
can change the blue color ramp to a green one that is more visually suited to our
NDVI (greenness) data using the `colorRampPalette()` function in combination with
`colorBrewer`. Then we use `scale_fill_gradientn` to pass the list of colours
(here 20 different colours) to ggplot.

``` {r change-color-ramp }
cols <- colorRampPalette(brewer.pal(9, "YlGn"))
ggplot() +
  geom_raster(data = NDVI_HARV_stack_df , aes(x = x, y = y, fill = value)) +
  facet_wrap(~variable) +
  ggtitle("Landsat NDVI -- Improved Colors", subtitle = "NEON Harvard Forest Field Site") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_gradientn(name = "NDVI", colours = cols(20))
```

The yellow to green color ramp visually represents NDVI well given it's a
measure of greenness. Someone looking at the plot can quickly understand that
pixels that are more green, have a higher NDVI value.

> ## Data Tip
> For all of the `brewer.pal` ramp names see the [brewerpal page](http://www.datavis.ca/sasmac/brewerpal.html).
{: .callout}

> ## Data Tip
> Cynthia Brewer, the creater of
> ColorBrewer, offers an online tool to help choose suitable color ramps, or to
> create your own. [ColorBrewer 2.0; Color Advise for Cartography](http://colorbrewer2.org/)
{: .callout}

## Refine Plot & Tile Labels
Next, let's label each raster in our plot with the Julian day that the raster
represents. The current names come from the band (layer names) stored in the
`RasterStack` and first part each name is the Julian day.

To create a more meaningful label we can remove the "x" and replace it with
"day" using the `gsub()` function in `R`. The syntax is as follows:
`gsub("StringToReplace", "TextToReplaceIt", Robject)`.

First let's remove "_HARV_NDVI_crop" from each label.

```{r clean-up-names }

# view names for each raster layer
names(NDVI_HARV_stack)

# use gsub to modify label names.that we'll use for the plot
rasterNames  <- gsub("X", "Day ", names(NDVI_HARV_stack))

# view Names
rasterNames

# Remove HARV_NDVI_crop from the second part of the string
rasterNames  <- gsub("_HARV_ndvi_crop", "", rasterNames)

# view names for each raster layer
rasterNames
```
Once the names for each band have been reassigned, we can render our plot with
the new labels using a`labeller`.

```{r create-levelplot }
labels_names <- setNames(rasterNames, unique(NDVI_HARV_stack_df$variable))

ggplot() +
  geom_raster(data = NDVI_HARV_stack_df , aes(x = x, y = y, fill = value)) +
  facet_wrap(~variable, labeller = labeller(variable=labels_names)) +
  ggtitle("Landsat NDVI - Julian Days", subtitle = "Harvard Forest 2011") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_gradientn(name = "NDVI", colours = cols(20))
```

We can adjust the columns of our plot too by setting the number of columns `ncol`
and the number of rows `nrow` in `facet_wrap`. Below
we adjust the layout to be a matrix of 5 columns and 3 rows.

```{r adjust-layout }
ggplot() +
  geom_raster(data = NDVI_HARV_stack_df , aes(x = x, y = y, fill = value)) +
  # create a 5x3 layout for the data
  facet_wrap(~variable, nrow=3, ncol=5, labeller = labeller(variable=labels_names)) +
  ggtitle("Landsat NDVI - Julian Days", subtitle = "Harvard Forest 2011") +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_fill_gradientn(name = "NDVI", colours = cols(20))
```

Finally, `scales` allows us to modify the x and y-axis scale. Let's simply
remove the axis ticks from the plot with `scales = list(draw=FALSE)`.

```{r remove-axis-ticks }
ggplot() +
  geom_raster(data = NDVI_HARV_stack_df , aes(x = x, y = y, fill = value)) +
  facet_wrap(~variable, nrow = 3, ncol = 5, labeller = labeller(variable = labels_names)) +
  ggtitle("Landsat NDVI - Julian Days", subtitle = "Harvard Forest 2011") +
  theme(plot.title = element_text(hjust = 0.5),
  # remove x and y-axis title, text and ticks
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank()
        ) +
  # set same scale for both x and y coordinates
  coord_equal() +
  scale_fill_gradientn(name = "NDVI", colours = cols(20))
```

> ## Challenge: Divergent Color Ramps
>
> When we used `gsub` to modify the tile labels we replaced the beginning of each
> tile title with "Day". A more descriptive name could be "Julian Day".
>
> 1. Create a plot and label each tile "Julian Day" with the julian day value
> following.
> 2. Change the colorramp to a divergent brown to green color ramp to
> represent the data. *Hint:* Use the
> [brewerpal page](http://www.datavis.ca/sasmac/brewerpal.html)
> to help choose a color ramp.
>
> **Questions:**
> Does having a divergent color ramp represent the data
> better than a sequential color ramp (like "YlGn")? Can you think of other data
> sets where a divergent color ramp may be best?
>
> > ## Answers
> >
> > ```{r challenge-code-levelplot-divergent, echo=TRUE}
> > # change Day to Julian Day
> > rasterNames  <- gsub("Day","Julian Day ", rasterNames)
> > # create a new color ramp
> > cols <- colorRampPalette(brewer.pal(9, "BrBG"))
> > ggplot() +
> >  geom_raster(data = NDVI_HARV_stack_df , aes(x = x, y = y, fill = value)) +
> >  facet_wrap(~variable, nrow=3, ncol=5, labeller = labeller(variable=labels_names)) +
> >  ggtitle("Landsat NDVI - Julian Days", subtitle = "Harvard Forest 2011") +
> >  theme(plot.title = element_text(hjust = 0.5)) +
> >  scale_fill_gradientn(name = "NDVI", colours = cols(20))
> >
> > # The sequential is better than the divergent as it is more akin to the process
> > # of greening up, which starts off at one end and just keeps increasing.
> >
> > ```
> {: .solution}
{: .challenge}
